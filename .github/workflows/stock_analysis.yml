name: Taiwan Stock Analysis - Two Stage

on:
  schedule:
    # 階段1: 每小時執行一次 (UTC 時間)
    - cron: '0 * * * *'
    # 階段2: 周日到周五 9:00-12:00 (台灣時間 = UTC 1:00-4:00)
    - cron: '0 1-4 * * 0-5'
    # 特殊任務: 周日到周五 14:00 刪除新聞檔案 (台灣時間 = UTC 6:00)
    - cron: '0 6 * * 0-5'
  
  # 允許手動觸發
  workflow_dispatch:
    inputs:
      stage:
        description: '執行階段 (1=新聞收集, 2=股價抓取)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
      process_mode:
        description: '處理模式 (TSE=上市, OTC=上櫃, BOTH=兩者)'
        required: true
        default: 'BOTH'
        type: choice
        options:
          - 'TSE'
          - 'OTC'
          - 'BOTH'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml pytz pandas
    
    - name: Create StockInfo directory
      run: mkdir -p StockInfo
    
    # 判斷執行階段
    - name: Determine stage
      id: determine_stage
      run: |
        HOUR=$(TZ='Asia/Taipei' date '+%H')
        DAY_OF_WEEK=$(TZ='Asia/Taipei' date '+%u')  # 1=週一, 7=週日
        echo "Current hour: $HOUR, Day of week: $DAY_OF_WEEK"
        
        # 手動觸發時使用指定的階段
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          STAGE="${{ github.event.inputs.stage }}"
          echo "Manual trigger - Stage: $STAGE"
        # 周日到周五 (0=週日, 1-5=週一到週五) 9-12點執行階段2
        elif [ "$DAY_OF_WEEK" = "7" ] || [ "$DAY_OF_WEEK" -le "5" ]; then
          if [ "$HOUR" -ge "09" ] && [ "$HOUR" -le "12" ]; then
            STAGE="2"
            echo "Time-based trigger (Sun-Fri 9-12am) - Stage 2"
          else
            STAGE="1"
            echo "Time-based trigger (other hours) - Stage 1"
          fi
        else
          STAGE="1"
          echo "Time-based trigger (Saturday) - Stage 1"
        fi
        
        echo "stage=$STAGE" >> $GITHUB_OUTPUT
    
    # 刪除新聞檔案 (周日到周五下午2點)
    - name: Delete news file at 2 PM
      run: |
        HOUR=$(TZ='Asia/Taipei' date '+%H')
        DAY_OF_WEEK=$(TZ='Asia/Taipei' date '+%u')
        
        if [ "$HOUR" = "14" ] && ([ "$DAY_OF_WEEK" = "7" ] || [ "$DAY_OF_WEEK" -le "5" ]); then
          echo "Deleting twstock_news.json at 2 PM (Taiwan time)"
          rm -f StockInfo/twstock_news.json
        else
          echo "Not time to delete news file (Current: $HOUR:00, Day: $DAY_OF_WEEK)"
        fi
    
    - name: Run stock analysis
      env:
        STAGE: ${{ steps.determine_stage.outputs.stage }}
        PROCESS_MODE: ${{ github.event.inputs.process_mode || 'BOTH' }}
      run: python stock_analysis.py
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add StockInfo/
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update stock data - Stage ${{ steps.determine_stage.outputs.stage }} - $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')" && git pull --rebase origin main && git push)