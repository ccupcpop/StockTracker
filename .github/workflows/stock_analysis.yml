name: Taiwan Stock Analysis - Two Stage

on:
  schedule:
    # éšæ®µ1: æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ (UTC æ™‚é–“)
    - cron: '0 * * * *'
    # éšæ®µ2: å‘¨æ—¥åˆ°å‘¨äº” 9:00-12:00 (å°ç£æ™‚é–“ = UTC 1:00-4:00)
    - cron: '0 1-4 * * 0-5'
    # ç‰¹æ®Šä»»å‹™: å‘¨æ—¥åˆ°å‘¨äº” 14:00 åˆªé™¤æ–°èæª”æ¡ˆ (å°ç£æ™‚é–“ = UTC 6:00)
    - cron: '0 6 * * 0-5'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      stage:
        description: 'åŸ·è¡Œéšæ®µ (1=æ–°èæ”¶é›†, 2=è‚¡åƒ¹æŠ“å–)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
      process_mode:
        description: 'è™•ç†æ¨¡å¼ (TSE=ä¸Šå¸‚, OTC=ä¸Šæ«ƒ, BOTH=å…©è€…)'
        required: true
        default: 'BOTH'
        type: choice
        options:
          - 'TSE'
          - 'OTC'
          - 'BOTH'

jobs:
  analyze-stocks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml pytz pandas
    
    - name: Create StockInfo directory
      run: mkdir -p StockInfo
    
    # åˆ¤æ–·åŸ·è¡Œéšæ®µ
    - name: Determine stage
      id: determine_stage
      run: |
        HOUR=$(TZ='Asia/Taipei' date '+%H')
        DAY_OF_WEEK=$(TZ='Asia/Taipei' date '+%u')  # 1=é€±ä¸€, 7=é€±æ—¥
        echo "Current hour: $HOUR, Day of week: $DAY_OF_WEEK"
        
        # æ‰‹å‹•è§¸ç™¼æ™‚ä½¿ç”¨æŒ‡å®šçš„éšæ®µ
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          STAGE="${{ github.event.inputs.stage }}"
          echo "Manual trigger - Stage: $STAGE"
        # å‘¨æ—¥åˆ°å‘¨äº” (0=é€±æ—¥, 1-5=é€±ä¸€åˆ°é€±äº”) 9-12é»åŸ·è¡Œéšæ®µ2
        elif [ "$DAY_OF_WEEK" = "7" ] || [ "$DAY_OF_WEEK" -le "5" ]; then
          if [ "$HOUR" -ge "09" ] && [ "$HOUR" -le "12" ]; then
            STAGE="2"
            echo "Time-based trigger (Sun-Fri 9-12am) - Stage 2"
          else
            STAGE="1"
            echo "Time-based trigger (other hours) - Stage 1"
          fi
        else
          STAGE="1"
          echo "Time-based trigger (Saturday) - Stage 1"
        fi
        
        echo "stage=$STAGE" >> $GITHUB_OUTPUT
    
    # å‚™ä»½ä¸¦åˆªé™¤æ–°èæª”æ¡ˆ (å‘¨æ—¥åˆ°å‘¨äº”ä¸‹åˆ2é»)
    - name: Backup and delete news file at 2 PM
      id: backup_at_2pm
      run: |
        HOUR=$(TZ='Asia/Taipei' date '+%H')
        DAY_OF_WEEK=$(TZ='Asia/Taipei' date '+%u')
        DATE=$(TZ='Asia/Taipei' date '+%Y%m%d')
        
        # è¨­å®šä¸€å€‹ flag ä¾†è¨˜éŒ„æ˜¯å¦æœ‰åŸ·è¡Œå‚™ä»½
        echo "backup_executed=false" >> $GITHUB_OUTPUT
        
        if [ "$HOUR" = "14" ] && ([ "$DAY_OF_WEEK" = "7" ] || [ "$DAY_OF_WEEK" -le "5" ]); then
          echo "ğŸ“… Current Taiwan time: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')"
          
          # æª¢æŸ¥æ–°èæª”æ¡ˆæ˜¯å¦å­˜åœ¨
          if [ -f "StockInfo/twstock_news.json" ]; then
            # å‚™ä»½æ–°èæª”æ¡ˆ (åŠ ä¸Šæ—¥æœŸ)
            echo "ğŸ“¦ Backing up twstock_news.json to twstock_news_${DATE}.json before deletion"
            cp -f StockInfo/twstock_news.json StockInfo/twstock_news_${DATE}.json
            echo "âœ… Backup created: StockInfo/twstock_news_${DATE}.json"
            
            # é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
            echo "ğŸ“„ Backup file info:"
            ls -lh StockInfo/twstock_news_${DATE}.json
            
            # è¨­å®š flag ç‚º true
            echo "backup_executed=true" >> $GITHUB_OUTPUT
            
            # åˆªé™¤åŸå§‹æ–°èæª”æ¡ˆ
            echo "ğŸ—‘ï¸  Deleting twstock_news.json at 2 PM (Taiwan time)"
            rm -f StockInfo/twstock_news.json
            echo "âœ… Original file deleted: StockInfo/twstock_news.json"
          else
            echo "âš ï¸  twstock_news.json not found, nothing to backup"
          fi
        else
          echo "â° Not time to backup/delete news file (Current: $HOUR:00, Day: $DAY_OF_WEEK)"
        fi
    
    # å¦‚æœåœ¨ä¸‹åˆ2é»æœ‰åŸ·è¡Œå‚™ä»½,å…ˆ commit å‚™ä»½æª”æ¡ˆ
    - name: Commit backup file at 2 PM
      if: steps.backup_at_2pm.outputs.backup_executed == 'true'
      run: |
        DATE=$(TZ='Asia/Taipei' date '+%Y%m%d')
        TAIWAN_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
        
        echo "ğŸ“¤ Committing backup file to repository..."
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add StockInfo/twstock_news_${DATE}.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Backup news file before deletion - ${TAIWAN_TIME}" && git pull --rebase origin main && git push)
        echo "âœ… Backup file committed and pushed to repository"
    
    - name: Run stock analysis
      env:
        STAGE: ${{ steps.determine_stage.outputs.stage }}
        PROCESS_MODE: ${{ github.event.inputs.process_mode || 'BOTH' }}
      run: python stock_analysis.py
    
    # éšæ®µ1åŸ·è¡Œå®Œç•¢å¾Œç«‹å³å‚™ä»½æ–°èæª”æ¡ˆ
    - name: Backup news file after Stage 1
      if: steps.determine_stage.outputs.stage == '1'
      run: |
        DATE=$(TZ='Asia/Taipei' date '+%Y%m%d')
        TAIWAN_TIME=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
        
        echo "ğŸ“… Current Taiwan time: $TAIWAN_TIME"
        echo "ğŸ” Checking if twstock_news.json exists..."
        
        if [ -f "StockInfo/twstock_news.json" ]; then
          echo "ğŸ“¦ Backing up twstock_news.json to twstock_news_${DATE}.json"
          cp -f StockInfo/twstock_news.json StockInfo/twstock_news_${DATE}.json
          echo "âœ… Backup created: StockInfo/twstock_news_${DATE}.json"
          
          # é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
          echo "ğŸ“„ File info:"
          ls -lh StockInfo/twstock_news*.json
        else
          echo "âš ï¸  twstock_news.json not found after Stage 1 execution"
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add StockInfo/
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update stock data - Stage ${{ steps.determine_stage.outputs.stage }} - $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')" && git pull --rebase origin main && git push)
